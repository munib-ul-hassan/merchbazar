<% layout('layouts/adminLayout') -%>
<%-block('title','<title> Checkout Page </title>')%>


<section class="checkout">
  <div class="container-fluid px-lg-5">
    <div class="row mb-4">
      <div class="col-12">
        <h3 class="text-black">Checkout</h3>
      </div>
    </div>
    <form class="checkout-form">
      <div class="row">
        <div class="col-lg-8">
          <div class="biling-info">
            <h6>Billing information</h6>

            <div class="row">
              <div class="col-lg-3 col-md-6">
                <div class="form-group">
                  <label for="first_name">User Name</label>
                  <input type="text" name="userName" id="userName" placeholder="First name" class="form-control" value="<%- userData.firstName -%>">
                    <p id="userNameError"></p>
                </div>
              </div>
              <div class="col-lg-3 col-md-6">
                <div class="form-group">
                  <label for="last_name" class="opacity-0">l</label>
                  <input type="text" name="lastName" id="lastName" placeholder="Last name" class="form-control" value="<%- userData.lastName -%>">
                  <p id="lastNameError"></p>
               </div>
              </div>
              <div class="col-lg-6">
                <div class="form-group">
                  <label for="company_name">Company Name <span>(Optional)</span></label>
                  <input type="text" name="companyName" id="companyName" class="form-control">
                  <p id="companyNameError"></p>
                </div>
              </div>
              <div class="col-lg-12">
                <div class="form-group">
                  <label for="address">Address</label>
                  <input type="text" name="address" id="address" class="form-control">
                  <p id="addressError"></p>
                </div>
              </div>
              <div class="col-lg-3 col-md-6">
                <div class="form-group">
                  <label for="country">Country</label>
                  <select name="country" id="country" class="form-control form-select">
                    <% countriesData.map((item)=>{ %>
                    <option value="<%- item.countryName -%>"><%- item.countryName -%></option>
                    <% }) %>
                  </select>
                  <p id="countryError"></p>
                </div>
              </div>
              <div class="col-lg-3 col-md-6">
                <div class="form-group">
                  <label for="region-state">Region/State</label>
                  <select name="regionState" id="region-state" class="form-control form-select">
                    <option value="0">Select...</option>
                    <option value="0">Sindh</option>
                  </select>
                  <p id="regionError"></p>
                </div>
              </div>
              <div class="col-lg-3 col-md-6">
                <div class="form-group">
                  <label for="city">City</label>
                  <select name="city" id="city" class="form-control form-select">
                    <option value="0">Select...</option>
                    <option value="0">Karachi</option>
                  </select>
                  <p id="cityError"></p>
                </div>
              </div>
              <div class="col-lg-3 col-md-6">
                <div class="form-group">
                  <label for="zipcode">Zip Code</label>
                  <input type="number" name="zipCode" id="zipcode" class="form-control">
                  <p id="zipCodeError"></p>
                 </div>
              </div>
              <div class="col-lg-6">
                <div class="form-group">
                  <label for="email">Email</label>
                  <input type="email" name="email" id="email" class="form-control">
                  <p id="emailError"></p>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="form-group">
                  <label for="phone">Phone Number</label>
                  <input type="number" name="phoneNumber" id="phone" class="form-control">
                  <p id="phoneError"></p>
                </div>
              </div>
              <div class="col-lg-12">
                <form class="payment-box">
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <h5>Payment Option</h5>
                  <div class="row">
                    <div class="col-lg-6 col-md-7 mx-auto mb-4">
                      <div class="payment-method">
                        <div class="row">
                          <div class="col-lg-6 col-md-6">
                            <div class="form-group text-center">
                              <label for="payment_method" class="d-block"><img src="assets/images/CurrencyDollar.png" class="img-fluid mx-auto mb-2 d-block">Cash
                                on Delivery</label>
                              <input type="radio" name="paymentMethod" value="cod">
                            </div>
                          </div>
                          <div class="col-lg-6 col-md-6">
                            <div class="form-group text-center">
                              <label for="payment_method" class="d-block"><img src="assets/images/CreditCard.png" class="img-fluid mx-auto mb-2 d-block">Debid/Credit
                                Card</label>
                              <input type="radio" name="paymentMethod" value="card" checked>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-12">
                      <div class="form-group">
                        <label for="full_name">Full Name</label>
                        <input type="text" name="full_name" id="full_name" class="form-control">
                      </div>
                    </div>
                    <div class="col-lg-12">
                      <div class="form-group">
                        <label for="bank_name">Bank Name</label>
                        <input type="text" name="bank_name" id="bank_name" class="form-control">
                      </div>
                    </div>
                    <div class="col-lg-6 col-md-6">
                      <div class="form-group">
                        <label for="account_no">Account No</label>
                        <input type="number" placeholder="Account No" name="account_no" id="account_no" class="form-control">
                      </div>
                    </div>
                    <div class="col-lg-6 col-md-6">
                      <div class="form-group">
                        <label for="amount">Amount</label>
                        <input type="number" name="amount" id="amount" class="form-control">
                      </div>
                    </div>
                    <div class="col-lg-12">
                      <div class="form-group">
                        <label for="receipt">Receipt</label>
                        <input type="file" name="receipt" id="receipt" accept="image/png, image/jpeg" class="form-control">
                      </div>
                    </div>
                  </div>
                </form>
              </div>
              <div class="col-lg-12 mt-3">
                <h5 class="mb-4">Additional Information</h5>
                <div class="form-group">
                  <label for="order_notes">Order Notes <span>(Optional)</span></label>
                  <textarea name="orderNotes" class="form-control" placeholder="Notes about your order, e.g. special notes for delivery" id="order_notes" cols="30" rows="5"></textarea>
                  <p id="orderError"></p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="order-sum">
            <h6>Order Summary</h6>
            <% updatedCarts.map((item)=>{ %>
            <div class="summary-box mb-3 d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center gap-4">
                <p class="mb-0">1x</p>
                <img src="<%= item.product.designImage %>" class="img-fluid" width="40">
                <p class="mb-0 name"><%= item.product.title.substring(0,30) %></p>
              </div>
              <p class="text-black mb-0">PKR <%= item.totalPrice %></p>
            </div>

            <% }) %>



            <div class="cart-total">
              <h6>Cart Totals</h6>
              <div class="d-flex align-items-center justify-content-between mb-2">
                <p class="mb-0">Sub-total</p>
                <p class="mb-0">PKR <%- totalPriceVal -%></p>
              </div>
              <div class="d-flex align-items-center justify-content-between mb-2">
                <p class="mb-0">Shipping</p>
                <p class="mb-0">Free</p>
              </div>
              <div class="d-flex align-items-center justify-content-between mb-2">
                <p class="mb-0">Discount</p>
                <p class="mb-0">0.00</p>
              </div>
              <!-- <div class="d-flex align-items-center justify-content-between mb-4">
                                                <p class="mb-0">Tax</p>
                                                <p class="mb-0">PKR 2400</p>
                                            </div> -->
              <hr style="color: #9fa1a3;">
              <div class="d-flex align-items-center total justify-content-between mb-4">
                <p class="mb-0">Total</p>
                <p class="fw-semibold mb-0">PKR <%- totalPriceVal -%></p>
              </div>
              <button type="submit" class="my-btn bg-primary w-100 text-center text-uppercase">Place
                Order <i class="ms-2 fa-solid fa-arrow-right"></i></button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</section>


<script>
  $(document).ready(function() {
    console.log("==========")
    $('.checkout-form').submit(function(e) {
      e.preventDefault(); // Prevent the default form submission

   



        if($('#userName').val().trim() == '') { 
            $('#userName').addClass('is-invalid');
            $('#userNameError').text('Please Add user Name');
            $('#userNameError').addClass('text-danger');
            return
        }else { 
            $('#userName').removeClass('is-invalid');
            $('#userNameError').text(''); 
        }

        
        if($('#lastName').val().trim() == '') { 
            $('#lastName').addClass('is-invalid');
            $('#lastNameError').text('Please Add Last Name');
            $('#lastNameError').addClass('text-danger');
            return
        }else { 
            $('#lastName').removeClass('is-invalid');
            $('#lastNameError').text(''); 
        }

        if($('#companyName').val().trim() == '') { 
            $('#companyName').addClass('is-invalid');
            $('#companyNameError').text('Please Add Company Name');
            $('#companyNameError').addClass('text-danger');
            return
        }else { 
            $('#companyName').removeClass('is-invalid');
            $('#companyNameError').text(''); 
        }

        if($('#address').val().trim() == '') { 
            $('#address').addClass('is-invalid');
            $('#addressError').text('Please Add Address Name');
            $('#addressError').addClass('text-danger');
            return
        }else { 
            $('#address').removeClass('is-invalid');
            $('#addressError').text(''); 
        }

        if($('#country').val().trim() == '') { 
            $('#country').addClass('is-invalid');
            $('#countryError').text('Please Add Country Name');
            $('#countryError').addClass('text-danger');
            return
        }else { 
            $('#country').removeClass('is-invalid');
            $('#countryError').text(''); 
        }


        if($('#region-state').val().trim() == '') { 
            $('#region-state').addClass('is-invalid');
            $('#regionError').text('Please Add Region');
            $('#regionError').addClass('text-danger');
            return
        }else { 
            $('#region-state').removeClass('is-invalid');
            $('#regionError').text(''); 
        }


        if($('#city').val().trim() == '') { 
            $('#city').addClass('is-invalid');
            $('#cityError').text('Please Add City');
            $('#cityError').addClass('text-danger');
            return
        }else { 
            $('#city').removeClass('is-invalid');
            $('#cityError').text(''); 
        }


        
        if($('#zipcode').val().trim() == '') { 
            $('#zipcode').addClass('is-invalid');
            $('#zipCodeError').text('Please Add Zip Code');
            $('#zipCodeError').addClass('text-danger');
            return
        }else { 
            $('#zipcode').removeClass('is-invalid');
            $('#zipCodeError').text(''); 
        }



        if($('#email').val().trim() == '' ) { 
            $('#email').addClass('is-invalid');
            $('#emailError').text('Please Add Email Code');
            $('#emailError').addClass('text-danger');
            return
        }else { 
            $('#email').removeClass('is-invalid');
            $('#emailError').text(''); 
        }
        var formData = $(this).serialize();
        
      // Serialize form data

        console.log(formData)
        var fileInput = document.getElementById('receipt');
    var file = fileInput.files[0];
    
    var formData2 = new FormData();
        formData2.append("file",file)

console.log(formData2,"=============")
        $.ajax({
          url: '/api/upload',
      type: 'POST',
      data: formData2,
      processData: false,
      contentType: false,
        success: function(response) {
          // Handle successful response
          console.log(response);
          console.log('response');
          formData.image=response
        // formData.image=response
          
        },
        error: function(xhr, status, error) {
          // Handle errors
          console.log(xhr.responseText);
          // Optionally, display an error message to the user
        }
      });   
        
      // Make AJAX request
      $.ajax({
        type: 'POST',
        url: '/api/checkout',
        data: formData,
        success: function(response) {
          // Handle successful response
          console.log(response);
          console.log('response');
          alert('data Updated Success')     
        },
        error: function(xhr, status, error) {
          // Handle errors
          console.error(xhr.responseText);
          // Optionally, display an error message to the user
        }
      });    
    });
  });
</script>